@page "/"
@using System.Net.Http.Headers
@using System.Text.Json
@using Markdig
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Smart Voice AI - Advanced Analysis</PageTitle>

<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold">🎧 Smart Voice AI</h1>
        <p class="text-muted">Upload your video or audio files and decide how you want it analyzed.</p>
    </div>

    <div class="card custom-card h-100 mb-4">
        <div class="card-body p-4">

            <div class="row g-3 mb-4">

                <div class="col-md-4">
                    <label class="form-label fw-bold">🗣️ Output Language</label>
                    <select class="form-select" @bind="preferences.Language">
                        <option value="Turkish">🇹🇷 Turkish</option>
                        <option value="English">🇬🇧 English</option>
                        <option value="Spanish">🇪🇸 Spanish</option>
                        <option value="German">🇩🇪 German</option>
                        <option value="Russian">🇷🇺 Russian</option>
                        <option value="French">🇫🇷 French</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">🎙️ Source Type</label>
                    <select class="form-select" @bind="preferences.SourceType">
                        <option value="Lecture">Lecture / Academic</option>
                        <option value="Audiobook">Audiobook / Story</option>
                        <option value="Meeting">Meeting / Interview</option>
                        <option value="Podcast">Podcast / Chat</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">📝 Summary Style</label>
                    <select class="form-select" @bind="preferences.SummaryStyle">
                        <option value="Detailed">Detailed & Comprehensive</option>
                        <option value="Concise">Concise (Quick Read)</option>
                        <option value="BulletPoints">Bullet Points</option>
                    </select>
                </div>

            </div>

            <div class="quiz-container mb-4 d-flex justify-content-between">

                <div class="d-flex align-items-center">
                    <label class="switch" style="font-size: 10px;">
                        <input type="checkbox" @bind="preferences.IncludeQuiz">
                        <span class="slider"></span>
                    </label>
                    <span class="ms-3 fw-bold text-secondary" style="font-size: 1.1rem;">🧠 Include Quiz Questions?</span>
                </div>

                @if (preferences.IncludeQuiz)
                {
                    <div class="d-flex align-items-center animate__animated animate__fadeInRight">
                        <label class="me-3 fw-bold text-secondary">Count:</label>
                        <input type="number" class="form-control text-center"
                               style="width: 80px;"
                               min="1" max="10"
                               @bind="preferences.QuestionCount" />
                    </div>
                }
            </div>

            <hr class="text-muted opacity-25 my-4" />

            <ul class="nav nav-pills nav-fill mb-4 p-2"
                style="background-color: #e0e0e0; border-radius: 50px; box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;">
                <li class="nav-item me-2">
                    <button class="nav-link rounded-pill fw-bold d-flex align-items-center justify-content-center py-3 @(activeTab == "file" ? "active bg-primary shadow text-white" : "text-secondary")"
                            style="transition: all 0.3s ease;"
                            @onclick='() => activeTab = "file"'>
                        <span class="fs-5 me-2">📁</span> File Upload
                    </button>
                </li>

                <li class="nav-item">
                    <button class="nav-link rounded-pill fw-bold d-flex align-items-center justify-content-center py-3 @(activeTab == "youtube" ? "active bg-danger shadow text-white" : "text-secondary")"
                            style="transition: all 0.3s ease;"
                            @onclick='() => activeTab = "youtube"'>
                        <span class="fs-5 me-2">🎥</span> YouTube URL
                    </button>
                </li>
            </ul>

            <div class="mb-3">
                @if (activeTab == "file")
                {
                    <div class="animate__animated animate__fadeIn">
                        <label class="form-label fw-bold ps-1">Select File (audio or video)</label>

                        <div class="input-group">
                            <InputFile OnChange="@HandleFileSelection"
                                       class="form-control form-control-lg"
                                       accept=".mp3,.wav,.m4a,.mp4,.mov,.avi,.mkv"
                                       style="border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important;" />

                            <button class="btn btn-ai-analyze" type="button"
                                    @onclick="@SubmitFileAnalysis"
                                    disabled="@(selectedFile == null)"
                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                Analyze
                            </button>
                        </div>
                    </div>
}
                else if (activeTab == "youtube")
                {
                    <div class="animate__animated animate__fadeIn">
                        <label class="form-label fw-bold ps-1">Paste YouTube Link</label>

                        <div class="input-group">
                            <input type="text" 
                                   @bind="youtubeUrl"
                                   @bind:event="oninput"
                                   class="form-control form-control-lg ps-3"
                                   placeholder="https://www.youtube.com/watch?v=..."
                                   style="border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important;" />

                            <button class="btn btn-ai-analyze" type="button"
                                    @onclick="HandleYoutubeSubmit"
                                    disabled="@string.IsNullOrWhiteSpace(youtubeUrl)"
                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                Analyze
                            </button>
                        </div>
                    </div>
                }
            </div>

            @if (isProcessing)
            {
                <div class="d-flex justify-content-center align-items-center my-5 py-4">

                    <div class="loader">
                        <div>
                            <ul>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                                <li>
                                    <svg fill="currentColor" viewBox="0 0 90 120">
                                        <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                                    </svg>
                                </li>
                            </ul>
                        </div>
                        <span style="font-size: 0.9rem" class="mt-3 fw-bold text-secondary">AI is analyzing your content</span>
                        <span style="font-size: 0.7rem" class="mt-2 text-secondary">Larger files may take longer to process</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3">@errorMessage</div>
            }
        </div>
    </div>

    @if (apiResult != null)
    {
        @if (apiResult != null)
        {
            <div class="container px-0 animate__animated animate__fadeInUp">

                <div class="card custom-card mb-4">
                    <div class="floating-header bg-ai-blue text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <span class="fs-4 me-2">✨</span>
                            <h5 class="mb-0 fw-bold">AI Summary</h5>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark rounded-pill shadow-sm">@preferences.SummaryStyle</span>
                            <span class="badge bg-white text-success rounded-pill shadow-sm">@preferences.SourceType</span>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <div class="card-text markdown-content px-2">
                            @((MarkupString)ConvertMarkdownToHtml(apiResult.Summary))
                        </div>
                    </div>
                </div>

                <div class="card custom-card border-0 mb-5" style="background: transparent; box-shadow: none; min-height: auto;">

                    <button @onclick="ToggleTranscript" class="btn btn-transcript-toggle w-100 floating-header bg-secondary text-white d-flex justify-content-between align-items-center border-0 p-3" style="background: #e0e0e0; box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff !important; color: #555;">
                        <span class="fw-bold ps-3">📜 Original Transcript</span>
                        <span class="pe-3 fs-5">@(isTranscriptVisible ? "▲" : "▼")</span>
                    </button>

                    @if (isTranscriptVisible)
                    {
                        <div class="mt-4 animate__animated animate__fadeIn">
                            <div class="card custom-card">
                                <div class="card-body">
                                    <p class="card-text text-muted small" style="max-height: 400px; overflow-y: auto;">
                                        @apiResult.OriginalTranscription
                                    </p>
                                </div>
                            </div>
                        </div>
                    }
                </div>

            </div>
        }
    }
</div>

@code {
    private bool isProcessing = false;
    private string? errorMessage;
    private ProcessResponseDto? apiResult;
    private bool isTranscriptVisible = false;
    private string activeTab = "file";
    private string youtubeUrl = "";
    private IBrowserFile? selectedFile;

    // Object to hold user preferences
    private AnalysisPreferences preferences = new AnalysisPreferences();

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        // Hata mesajını temizle, yeni dosya seçildi
        errorMessage = null;
    }

    private async Task SubmitFileAnalysis()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file first.";
            return;
        }

        isProcessing = true;
        errorMessage = null;
        apiResult = null;
        isTranscriptVisible = false;

        try
        {
            long maxFileSize = 500L * 1024 * 1024; // 500 MB Limit

            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(selectedFile.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(selectedFile.ContentType);
            content.Add(fileContent, "file", selectedFile.Name);

            // Constructing the URL with Query Parameters 
            var url = $"api/AudioProcess/upload?" +
                      $"language={preferences.Language}&" +
                      $"sourceType={preferences.SourceType}&" +
                      $"style={preferences.SummaryStyle}&" +
                      $"includeQuiz={preferences.IncludeQuiz}&" +
                      $"qCount={preferences.QuestionCount}";

            var response = await Http.PostAsync(url, content);

            if (response.IsSuccessStatusCode)
            {
                apiResult = await response.Content.ReadFromJsonAsync<ProcessResponseDto>();

                StateHasChanged();
                await Task.Delay(100); 
                await JSRuntime.InvokeVoidAsync("renderMath");
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {response.StatusCode} - {errorMsg}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task HandleYoutubeSubmit()
    {
        if (string.IsNullOrWhiteSpace(youtubeUrl))
        {
            errorMessage = "Please enter a valid YouTube URL.";
            return;
        }

        isProcessing = true;
        errorMessage = null;
        apiResult = null;
        isTranscriptVisible = false;

        try
        {
            var requestUrl = $"api/AudioProcess/process-youtube?" +
                      $"url={Uri.EscapeDataString(youtubeUrl)}&" +
                      $"language={preferences.Language}&" +
                      $"sourceType={preferences.SourceType}&" +
                      $"style={preferences.SummaryStyle}&" +
                      $"includeQuiz={preferences.IncludeQuiz}&" +
                      $"qCount={preferences.QuestionCount}";

            var response = await Http.PostAsync(requestUrl, null);

            if (response.IsSuccessStatusCode)
            {
                apiResult = await response.Content.ReadFromJsonAsync<ProcessResponseDto>();
                await TriggerMathJax();
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {response.StatusCode} - {errorMsg}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
    private async Task TriggerMathJax()
    {
        StateHasChanged();
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("renderMath");
    }

    // Butona basınca tersine çeviren metot
    private void ToggleTranscript()
    {
        isTranscriptVisible = !isTranscriptVisible;
    }
    private string ConvertMarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return "";

        var pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions() 
            .Build();

        return Markdown.ToHtml(markdown, pipeline);
    }
    // Model for UI Preferences
    public class AnalysisPreferences
    {
        public string Language { get; set; } = "Turkish";
        public string SourceType { get; set; } = "Lecture";
        public string SummaryStyle { get; set; } = "Detailed";
        public bool IncludeQuiz { get; set; } = false;
        public int QuestionCount { get; set; } = 3;
    }

    public class ProcessResponseDto
    {
        public string OriginalTranscription { get; set; }
        public string Summary { get; set; }
        public List<string> QuizQuestions { get; set; }
    }
}
<style>
    .form-select, .form-control {
        background-color: #e0e0e0 !important; 
        border: none !important; 
        border-radius: 15px !important; 
        color: #555 !important; 
        box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff !important;
    }

        .form-select:focus, .form-control:focus {
            background-color: #e0e0e0 !important;
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff !important;
            outline: none !important;
        }

   .quiz-container {
        background-color: #e0e0e0; 
        border-radius:50px;
        padding: 1rem 2rem;
        box-shadow: inset 5px 5px 10px #bebebe, inset -5px -5px 10px #ffffff;
        min-height: 80px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease-in-out;
    }

    body {
        background-color: #e0e0e0;
    }

    .transcript-box {
        background-color: #e0e0e0;
        border-radius: 15px;
        padding: 15px;
        box-shadow: inset 5px 5px 10px #bebebe, inset -5px -5px 10px #ffffff;
        max-height: 400px;
        overflow-y: auto;
    }

    .custom-card {
        width: 100%;
        height: 100%;
        min-height: 300px;
        border-radius: 30px;

        background: #e0e0e0;
        box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
        border: none;
        padding: 20px;
        color: #333;
        overflow: hidden;
        
    }

    .floating-header {
        border-radius: 30px; 
        padding: 15px 20px; 
        margin-bottom: 20px; 
        box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
    }

    .switch {
        --button-width: 3.5em;
        --button-height: 2em;
        --toggle-diameter: 1.5em;
        --button-toggle-offset: calc((var(--button-height) - var(--toggle-diameter)) / 2);
        --toggle-shadow-offset: 10px;
        --toggle-wider: 3em;
        --color-grey: #cccccc;
        --color-green: #4296f4; 

        font-size: 10px;
    }

    .slider {
        display: inline-block;
        width: var(--button-width);
        height: var(--button-height);
        background-color: var(--color-grey);
        border-radius: calc(var(--button-height) / 2);
        position: relative;
        transition: 0.3s all ease-in-out;
        cursor: pointer;
    }

        .slider::after {
            content: "";
            display: inline-block;
            width: var(--toggle-diameter);
            height: var(--toggle-diameter);
            background-color: #fff;
            border-radius: calc(var(--toggle-diameter) / 2);
            position: absolute;
            top: var(--button-toggle-offset);
            transform: translateX(var(--button-toggle-offset));
            box-shadow: var(--toggle-shadow-offset) 0 calc(var(--toggle-shadow-offset) * 4) rgba(0, 0, 0, 0.1);
            transition: 0.3s all ease-in-out;
        }

    .switch input[type="checkbox"]:checked + .slider {
        background-color: var(--color-green);
    }

        .switch input[type="checkbox"]:checked + .slider::after {
            transform: translateX(calc(var(--button-width) - var(--toggle-diameter) - var(--button-toggle-offset)));
            box-shadow: calc(var(--toggle-shadow-offset) * -1) 0 calc(var(--toggle-shadow-offset) * 4) rgba(0, 0, 0, 0.1);
        }

    .switch input[type="checkbox"] {
        display: none;
    }

        .switch input[type="checkbox"]:active + .slider::after {
            width: var(--toggle-wider);
        }

        .switch input[type="checkbox"]:checked:active + .slider::after {
            transform: translateX(calc(var(--button-width) - var(--toggle-wider) - var(--button-toggle-offset)));
        }

    .bg-ai-blue {
        background-color: #4296f4 !important;
    }

    .btn-ai-analyze {
        background-color: #4296f4; 
        color: white;
        border: none;
        border-radius: 15px; /* Inputlarla uyumlu köşe */
        font-weight: bold;
        padding: 10px 25px;
        box-shadow: 0 4px 6px rgba(66, 150, 244, 0.3); 
        transition: all 0.3s ease;
    }

        /* Hover (Üzerine gelince) - Biraz daha koyu olsun */
        .btn-ai-analyze:hover {
            background-color: #1a73e8; /* Daha koyu mavi */
            color: white;
            transform: translateY(-2px); /* Hafif yukarı kalksın */
            box-shadow: 0 6px 12px rgba(26, 115, 232, 0.4);
        }

        /* Disabled (Pasif) Durum */
        .btn-ai-analyze:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

    /* --- BOOK LOAD ANIMATION --- */
    /* From Uiverse.io by Nawsome */ 
    .loader {
      --background: linear-gradient(135deg, #23C4F8, #275EFE);
      --shadow: rgba(39, 94, 254, 0.28);
      --text: #6C7486;
      --page: rgba(255, 255, 255, 0.36);
      --page-fold: rgba(255, 255, 255, 0.52);
      --duration: 3s;
      width: 200px;
      height: 140px;
      position: relative;
    }

    .loader:before, .loader:after {
      --r: -6deg;
      content: "";
      position: absolute;
      bottom: 8px;
      width: 120px;
      top: 80%;
      box-shadow: 0 16px 12px var(--shadow);
      transform: rotate(var(--r));
    }

    .loader:before {
      left: 4px;
    }

    .loader:after {
      --r: 6deg;
      right: 4px;
    }

    .loader div {
      width: 100%;
      height: 100%;
      border-radius: 13px;
      position: relative;
      z-index: 1;
      perspective: 600px;
      box-shadow: 0 4px 6px var(--shadow);
      background-image: var(--background);
    }

    .loader div ul {
      margin: 0;
      padding: 0;
      list-style: none;
      position: relative;
    }

    .loader div ul li {
      --r: 180deg;
      --o: 0;
      --c: var(--page);
      position: absolute;
      top: 10px;
      left: 10px;
      transform-origin: 100% 50%;
      color: var(--c);
      opacity: var(--o);
      transform: rotateY(var(--r));
      -webkit-animation: var(--duration) ease infinite;
      animation: var(--duration) ease infinite;
    }

    .loader div ul li:nth-child(2) {
      --c: var(--page-fold);
      -webkit-animation-name: page-2;
      animation-name: page-2;
    }

    .loader div ul li:nth-child(3) {
      --c: var(--page-fold);
      -webkit-animation-name: page-3;
      animation-name: page-3;
    }

    .loader div ul li:nth-child(4) {
      --c: var(--page-fold);
      -webkit-animation-name: page-4;
      animation-name: page-4;
    }

    .loader div ul li:nth-child(5) {
      --c: var(--page-fold);
      -webkit-animation-name: page-5;
      animation-name: page-5;
    }

    .loader div ul li svg {
      width: 90px;
      height: 120px;
      display: block;
      fill: currentColor; 
    }

    .loader div ul li:first-child {
      --r: 0deg;
      --o: 1;
    }

    .loader div ul li:last-child {
      --o: 1;
    }

    .loader span {
      display: block;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 20px;
      text-align: center;
      color: var(--text);
    }

    /* KEYFRAMES */
    @@keyframes page-2 {
      0% { transform: rotateY(180deg); opacity: 0; }
      20% { opacity: 1; }
      35%, 100% { opacity: 0; }
      50%, 100% { transform: rotateY(0deg); }
    }

    @@keyframes page-3 {
      15% { transform: rotateY(180deg); opacity: 0; }
      35% { opacity: 1; }
      50%, 100% { opacity: 0; }
      65%, 100% { transform: rotateY(0deg); }
    }

    @@keyframes page-4 {
      30% { transform: rotateY(180deg); opacity: 0; }
      50% { opacity: 1; }
      65%, 100% { opacity: 0; }
      80%, 100% { transform: rotateY(0deg); }
    }

    @@keyframes page-5 {
      45% { transform: rotateY(180deg); opacity: 0; }
      65% { opacity: 1; }
      80%, 100% { opacity: 0; }
      95%, 100% { transform: rotateY(0deg); }
    }

    .markdown-content {
        font-size: 1.05rem;
        line-height: 1.7;
    }

        /* headers (##) */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        /* Lists */
        .markdown-content ul,
        .markdown-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        /* bold text */
        .markdown-content strong {
            color: #000;
            font-weight: 700;
        }

    mjx-container[display="true"] {
        display: block !important; /* Blok gibi davran */
        text-align: center !important; /* Ortala */
        margin: 0.3rem 0 !important; /* Üstüne ve altına boşluk bırak */
        /* MOBİL UYUMU: Formül çok uzunsa ekranı patlatmasın, kaydırılsın */
        overflow-x: auto;
        overflow-y: hidden;
        max-width: 100%;
</style>